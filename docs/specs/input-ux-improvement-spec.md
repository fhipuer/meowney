# 자산 및 플랜 입력 편의성 개선 스펙

> 작성일: 2026-01-17
> 상태: 설계 완료, 구현 대기

## 1. 개요

### 배경 및 목적
현재 Meowney에서 자산을 추가하고 리밸런싱 플랜을 설정하는 과정이 번거로움:
- 자산 추가 시 수량/가격을 일일이 입력해야 함
- 플랜 편집 시 보유 자산 목록에서 원하는 자산을 찾기 어려움
- 비율 조정 시 전체 분포가 어떻게 변하는지 시각적 피드백 부족
- 증권사 데이터를 직접 가져올 방법이 없음

### 핵심 가치 제안
1. **플랜 자산 선택 UI 개선**: 보유 자산을 체크박스 목록으로 한눈에 보고 선택
2. **비율 시각화**: 실시간 파이차트로 배분 현황 즉시 확인
3. **자동 정규화**: 100%에 맞추기 위한 수동 계산 불필요
4. **클립보드 데이터 가져오기**: 증권사에서 복사한 데이터 자동 파싱 (Phase 2)

---

## 2. 요구사항

### 기능 요구사항 (우선순위 순)

#### Phase 1: 플랜 편집 UX 개선 (MVP)

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| F1.1 | 플랜 편집 시 보유 자산 체크박스 목록 표시 | 높음 |
| F1.2 | 체크박스 목록에 자산명, 현재가치, 비중 표시 | 높음 |
| F1.3 | 목표 비율 입력 시 실시간 파이차트 업데이트 | 높음 |
| F1.4 | "비율 정규화" 버튼 - 입력된 비율을 100%에 맞게 자동 조정 | 높음 |
| F1.5 | 파이차트 편집기 상단 고정 배치 | 중간 |
| F1.6 | 편집 중 자동 임시 저장 (localStorage) | 중간 |
| F1.7 | 저장 실패 시 임시 저장 데이터에서 복구 옵션 제공 | 중간 |

#### Phase 2: 데이터 가져오기 (추후 구현)

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| F2.1 | 설정 > 데이터 가져오기 메뉴 추가 | 중간 |
| F2.2 | 클립보드 붙여넣기 영역 (textarea) | 중간 |
| F2.3 | 미래에셋증권 포트폴리오 데이터 파싱 | 중간 |
| F2.4 | 파싱 결과 미리보기 테이블 | 중간 |
| F2.5 | 기존 자산과 중복 시 자동 업데이트 | 중간 |
| F2.6 | 추가 증권사 포맷 지원 (한투, 키움 등) | 낮음 |

### 비기능 요구사항

| ID | 요구사항 |
|----|----------|
| NF1 | 파이차트 업데이트 지연 100ms 이하 |
| NF2 | 체크박스 목록 최대 100개 자산 렌더링 시 프레임 드롭 없음 |
| NF3 | 임시 저장 데이터 최대 7일 보관 |
| NF4 | 모바일 반응형 지원 (체크박스 터치 영역 44px 이상) |

---

## 3. 사용자 시나리오

### 시나리오 1: 플랜에 자산 추가하기

**현재 (AS-IS)**:
1. "항목 추가" 버튼 클릭
2. 티커 직접 입력 또는 검색
3. 자산명 확인
4. 목표 비율 입력
5. 저장

**개선 후 (TO-BE)**:
1. "항목 추가" 버튼 클릭
2. 보유 자산 체크박스 목록이 표시됨 (자산명, 현재가치, 비중 함께)
3. 원하는 자산 체크
4. 목표 비율 입력 (파이차트가 실시간 업데이트)
5. "비율 정규화" 버튼으로 100%에 맞춤
6. 저장

### 시나리오 2: 비율 조정하기

**현재 (AS-IS)**:
1. 각 항목의 비율을 숫자로 입력
2. 합계가 100%인지 직접 계산
3. 100%가 아니면 다시 조정
4. 전체 분포 확인은 저장 후에만 가능

**개선 후 (TO-BE)**:
1. 편집기 상단의 파이차트에서 현재 분포 확인
2. 비율 입력 시 파이차트가 실시간 변경
3. 합계가 100%가 아니면 "비율 정규화" 클릭
4. 모든 비율이 자동으로 100%에 맞게 조정됨

### 시나리오 3: 증권사 데이터 가져오기 (Phase 2)

1. 미래에셋증권 앱/웹에서 포트폴리오 데이터 복사
2. 설정 > 데이터 가져오기 이동
3. 텍스트 영역에 붙여넣기
4. 파싱 결과 미리보기 확인
5. "가져오기" 버튼 클릭
6. 기존 자산과 중복되면 자동 업데이트

---

## 4. 기술 설계

### 4.1 아키텍처

```
┌─────────────────────────────────────────────────┐
│             AllocationEditor.tsx                │
│  ┌─────────────────────────────────────────┐   │
│  │        RealTimePieChart (NEW)           │   │
│  │   - 실시간 비율 시각화                    │   │
│  │   - Recharts PieChart 사용               │   │
│  └─────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────┐   │
│  │      AssetSelectorModal (NEW)           │   │
│  │   - 보유 자산 체크박스 목록               │   │
│  │   - 자산명 + 현재가치 + 비중 표시         │   │
│  │   - 검색/필터 기능                       │   │
│  └─────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────┐   │
│  │      NormalizeButton (NEW)              │   │
│  │   - 비율 100% 정규화                     │   │
│  └─────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────┐   │
│  │      useAutoSave (NEW Hook)             │   │
│  │   - localStorage 자동 저장               │   │
│  │   - 복구 기능                            │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
```

### 4.2 컴포넌트 설계

#### 4.2.1 RealTimePieChart

```typescript
interface RealTimePieChartProps {
  allocations: AllocationItem[]
  groups: GroupState[]
  totalPercentage: number  // 합계 표시용
}

// 기존 PortfolioDonut과 유사하지만 편집 모드용으로 경량화
// - 툴팁 비활성화 (성능)
// - 애니메이션 최소화
// - 100% 초과/미만 시 시각적 경고
```

#### 4.2.2 AssetSelectorModal

```typescript
interface AssetSelectorModalProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  assets: Asset[]
  selectedAssetIds: string[]
  onSelect: (assetIds: string[]) => void
  mode: 'individual' | 'group'  // 개별 추가 vs 그룹에 추가
  groupId?: string  // 그룹에 추가 시
}

// 표시 정보:
// - 체크박스
// - 자산명 (ticker 있으면 함께)
// - 현재가치 (KRW 환산)
// - 포트폴리오 내 비중 (%)
// - 이미 플랜에 있는 자산은 비활성화 + 표시
```

#### 4.2.3 useAutoSave Hook

```typescript
interface UseAutoSaveOptions {
  key: string  // localStorage 키 (plan ID 기반)
  data: unknown  // 저장할 데이터
  debounceMs?: number  // 디바운스 (기본 1000ms)
}

interface UseAutoSaveReturn {
  hasRecoveryData: boolean
  recover: () => unknown | null
  clearRecovery: () => void
  lastSaved: Date | null
}
```

### 4.3 데이터 흐름

```
사용자 비율 입력
      ↓
AllocationEditor state 업데이트
      ↓
┌─────────────────────────────────────┐
│  동시 실행:                          │
│  1. RealTimePieChart 리렌더링        │
│  2. useAutoSave 디바운스 저장         │
│  3. 합계 계산 및 경고 표시            │
└─────────────────────────────────────┘
```

### 4.4 비율 정규화 알고리즘

```typescript
function normalizeRatios(items: { id: string; ratio: number }[]): Map<string, number> {
  const total = items.reduce((sum, item) => sum + item.ratio, 0)
  if (total === 0) return new Map()

  const result = new Map<string, number>()
  let remaining = 100

  // 마지막 항목 제외하고 비례 배분
  items.slice(0, -1).forEach(item => {
    const normalized = Math.round((item.ratio / total) * 100 * 100) / 100  // 소수점 2자리
    result.set(item.id, normalized)
    remaining -= normalized
  })

  // 마지막 항목은 나머지로 (반올림 오차 보정)
  if (items.length > 0) {
    result.set(items[items.length - 1].id, Math.round(remaining * 100) / 100)
  }

  return result
}
```

---

## 5. UI/UX 설계

### 5.1 플랜 편집기 레이아웃 (개선 후)

```
┌─────────────────────────────────────────────────┐
│  플랜 편집: 2026 포트폴리오 1분기                  │
├─────────────────────────────────────────────────┤
│  ┌───────────────────┐  목표 비율 합계: 95.0%    │
│  │                   │  ⚠️ 100%가 아닙니다       │
│  │   [파이차트]       │  [비율 정규화] 버튼       │
│  │                   │                          │
│  └───────────────────┘                          │
├─────────────────────────────────────────────────┤
│  [균등 배분] [현재 비율 적용] [항목 추가] [그룹 추가] │
├─────────────────────────────────────────────────┤
│  개별 배분                                       │
│  ┌─────────────────────────────────────────┐   │
│  │ □ AAPL (Apple Inc.)        45.2%  [🗑]  │   │
│  │   ₩15,927,154  현재 11.7%              │   │
│  └─────────────────────────────────────────┘   │
│  그룹 배분                                       │
│  ┌─────────────────────────────────────────┐   │
│  │ ▼ AI 반도체 슈퍼사이클 (2개)   50.0%  [🗑]  │   │
│  │   ├ TIGER 코스피       ₩88,638,360     │   │
│  │   └ SMH (USD)          ₩15,927,154     │   │
│  └─────────────────────────────────────────┘   │
├─────────────────────────────────────────────────┤
│  [취소]                              [저장]      │
│                        💾 자동 저장됨 (30초 전)   │
└─────────────────────────────────────────────────┘
```

### 5.2 자산 선택 모달

```
┌─────────────────────────────────────────────────┐
│  보유 자산 선택                            [X]   │
├─────────────────────────────────────────────────┤
│  🔍 검색...                                     │
├─────────────────────────────────────────────────┤
│  ☑️ 전체 선택 (8개)                             │
├─────────────────────────────────────────────────┤
│  ☑️ 삼성전자 (005930.KS)                        │
│     ₩45,000,000  비중 33.2%                    │
│  ─────────────────────────────────────────────  │
│  ☐ Apple Inc. (AAPL)                   [이미 추가됨] │
│     ₩15,927,154  비중 11.7%                    │
│  ─────────────────────────────────────────────  │
│  ☑️ TIGER 코스피 (277630.KS)                    │
│     ₩88,638,360  비중 65.3%                    │
├─────────────────────────────────────────────────┤
│  [취소]                    [2개 선택 완료]       │
└─────────────────────────────────────────────────┘
```

---

## 6. 보안 고려사항

| 항목 | 대응 |
|------|------|
| localStorage 데이터 | 민감 정보(자산명, 금액) 포함 → 암호화 불필요 (로컬 전용) |
| 클립보드 데이터 | 사용자가 직접 붙여넣기 → XSS 방지를 위한 sanitize 필요 |
| 자동 저장 데이터 만료 | 7일 후 자동 삭제 (stale 데이터 방지) |

---

## 7. 테스트 계획

### 7.1 Playwright UI 테스트

| 테스트 케이스 | 설명 |
|---------------|------|
| TC1 | 플랜 편집 열기 → 파이차트 표시 확인 |
| TC2 | 비율 변경 → 파이차트 실시간 업데이트 확인 |
| TC3 | "비율 정규화" 클릭 → 합계 100% 확인 |
| TC4 | "항목 추가" → 자산 선택 모달 열림 확인 |
| TC5 | 자산 체크 → 플랜에 추가됨 확인 |
| TC6 | 편집 중 브라우저 새로고침 → 복구 프롬프트 확인 |
| TC7 | 복구 선택 → 이전 데이터 복원 확인 |

### 7.2 수동 테스트 체크리스트

- [ ] 파이차트 애니메이션이 부드러운가
- [ ] 자산 50개 이상일 때 목록 스크롤이 원활한가
- [ ] 모바일에서 체크박스 터치가 용이한가
- [ ] 다크 모드에서 파이차트 색상이 구분되는가

---

## 8. 제약사항 및 가정

### 제약사항
- Phase 1은 프론트엔드만 수정 (백엔드 API 변경 없음)
- 클립보드 데이터 파싱은 Phase 2로 분리
- 미래에셋증권 외 증권사는 데이터 포맷 확인 후 추가 지원

### 가정
- 사용자는 최대 100개 이하의 자산을 보유
- 플랜당 최대 20개 이하의 배분 항목/그룹 설정
- localStorage 용량 충분 (5MB 이상)

---

## 9. 미결정 사항 / 추후 논의 필요

- [ ] 미래에셋증권 포트폴리오 데이터 복사 형식 확인 필요
- [ ] 정규화 시 소수점 처리 방식 (반올림 vs 버림)
- [ ] 그룹에 자산 추가 시 UI 흐름 최종 확정
- [ ] Phase 2 클립보드 파싱 정확도 목표치 설정

---

## 10. 구현 계획

### Phase 1 (MVP) - 예상 작업

1. `RealTimePieChart` 컴포넌트 생성
2. `AssetSelectorModal` 컴포넌트 생성
3. `AllocationEditor` 상단에 파이차트 배치
4. "비율 정규화" 버튼 및 로직 추가
5. "항목 추가" 버튼 클릭 시 AssetSelectorModal 연결
6. `useAutoSave` 훅 구현
7. 복구 UI 추가
8. Playwright 테스트 작성

### Phase 2 - 데이터 가져오기

1. 설정 페이지에 "데이터 가져오기" 메뉴 추가
2. 클립보드 파싱 로직 구현 (미래에셋 우선)
3. 미리보기 UI 구현
4. 중복 처리 로직 구현
5. 추가 증권사 포맷 지원
